<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Micro Casino Arcade</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:rgba(255,255,255,.04);
      --panel2:rgba(0,0,0,.30);
      --stroke:rgba(255,255,255,.12);
      --ink:#e7eefc;
      --muted:#9fb0cc;
      --good:#48d38a;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --shadow: 0 16px 44px rgba(0,0,0,.45);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(122,167,255,.18), transparent 55%),
        radial-gradient(900px 700px at 90% 10%, rgba(72,211,138,.10), transparent 60%),
        var(--bg);
      color:var(--ink);
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:18px 16px 22px;
    }
    .app{
      width:min(1100px, 100%);
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:16px;
      align-items:start;
    }
    header{
      grid-column:1 / -1;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:14px 14px;
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
    }
    .brand{ display:flex; align-items:baseline; gap:10px; flex-wrap:wrap; }
    .brand h1{ margin:0; font-size:16px; letter-spacing:.3px; font-weight:900;}
    .brand .sub{ color:var(--muted); font-size:12px; }
    .row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    button, .chip{
      appearance:none;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color:var(--ink);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
      font-weight:800;
      font-size: 13px;
      user-select:none;
    }
    button:hover{ background: rgba(255,255,255,.07); border-color: rgba(122,167,255,.35); }
    button:active{ transform: translateY(1px); }
    button.primary{ border-color: rgba(72,211,138,.35); }
    button.danger{ border-color: rgba(255,107,107,.35); }
    button.ghost{ background: transparent; }

    .stage, .sidebar{
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      padding:14px;
    }
    .sidebar{ display:flex; flex-direction:column; gap:12px; }

    .topline{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; margin-bottom:10px; flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      color:var(--muted);
      font-size:12px;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;
      background:var(--warn);
      box-shadow:0 0 0 3px rgba(255,204,102,.14);
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
    }
    .card{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      border-radius: 16px;
      padding: 12px;
    }
    .card h2{ margin:0 0 8px; font-size: 14px; letter-spacing:.2px; }
    .card p{ margin:0; color:var(--muted); font-size: 13px; line-height:1.45; }

    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .stat{
      border:1px solid var(--stroke);
      border-radius: 14px;
      padding:10px;
      background: rgba(255,255,255,.03);
    }
    .stat .label{ color:var(--muted); font-size:12px; }
    .stat .value{ font-size:18px; font-weight: 950; margin-top:2px; }

    .offers{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      margin-top:12px;
    }
    .offer{
      border:1px solid var(--stroke);
      border-radius: 16px;
      padding:12px;
      background: rgba(255,255,255,.03);
      cursor:pointer;
      transition: transform .08s ease, border-color .2s ease, background .2s ease;
      user-select:none;
      text-align:left;
    }
    .offer:hover{ transform: translateY(-1px); border-color: rgba(122,167,255,.35); background: rgba(255,255,255,.05); }
    .offer .name{ font-weight: 900; font-size: 14px; margin-bottom: 6px; }
    .offer .meta{ color: var(--muted); font-size: 12px; line-height: 1.35; }
    .offer .big{ font-weight: 950; font-size: 18px; margin-top: 10px; }

    .bar{
      height: 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--stroke);
      overflow:hidden;
    }
    .bar > div{ height:100%; }

    .list{
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height: 280px;
      overflow:auto;
      padding-right:4px;
    }
    .log{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      border-radius: 14px;
      padding:10px;
      color: var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    .log b{ color: var(--ink); }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.55);
      color: var(--ink);
      font-size: 13px;
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      box-shadow: var(--shadow);
      z-index: 50;
      max-width: min(720px, calc(100vw - 32px));
      text-align:center;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{ opacity: 1; transform: translateX(-50%) translateY(-4px); }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .tab{ padding:8px 10px; border-radius: 999px; }
    .tab.active{ border-color: rgba(72,211,138,.45); background: rgba(72,211,138,.10); }

    .twoCol{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top: 12px; }
    .muted{ color: var(--muted); }
    .good{ color: var(--good); }
    .warn{ color: var(--warn); }
    .bad{ color: var(--bad); }

    @media (max-width: 940px){
      .app{ grid-template-columns: 1fr; }
      .offers{ grid-template-columns: 1fr; }
      .grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <h1>Micro Casino Arcade</h1>
        <div class="sub">tiny probability games • fast runs • transparent odds</div>
      </div>
      <div class="row">
        <button id="btnHome" class="ghost">Home</button>
        <button id="btnResetAll" class="danger">Reset All</button>
      </div>
    </header>

    <section class="stage">
      <div class="topline">
        <div class="pill"><span class="dot"></span> Pick a game. All odds are shown. Score comes from smart risk.</div>
        <div class="pill">Best: <b id="bestAll">0</b></div>
      </div>

      <div id="screenHome">
        <div class="grid">
          <div class="card">
            <h2>Odds Ladder</h2>
            <p>
              Choose 1 of 3 offers each round. Win → climb. Lose → run ends. Cash out anytime.
              Pure “I should stop… but what if…”.
            </p>
            <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
              <button class="primary" data-open="ladder">Play</button>
            </div>
          </div>
          <div class="card">
            <h2>Roulette Draft</h2>
            <p>
              Draft a slip of probability tiles. Spin to resolve all at once. Huge parlays, huge heartbreak.
            </p>
            <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
              <button class="primary" data-open="draft">Play</button>
            </div>
          </div>
          <div class="card">
            <h2>Lootbox Math</h2>
            <p>
              Open packs with transparent odds. Use limited actions to shift probabilities. Chase the epic hit.
            </p>
            <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
              <button class="primary" data-open="loot">Play</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ODDS LADDER -->
      <div id="screenLadder" style="display:none;">
        <div class="topline">
          <div class="pill"><b>Odds Ladder</b> — cash out to bank your run</div>
          <div class="tabs">
            <span class="chip tab active" id="ladderTab">Play</span>
            <button class="tab" id="ladderNew">New Run</button>
            <button class="tab" id="ladderCash">Cash Out</button>
          </div>
        </div>

        <div class="card">
          <div class="stats">
            <div class="stat"><div class="label">Run Bank</div><div class="value" id="ladderBank">0</div></div>
            <div class="stat"><div class="label">Round</div><div class="value" id="ladderRound">1</div></div>
            <div class="stat"><div class="label">Rerolls</div><div class="value" id="ladderReroll">2</div></div>
            <div class="stat"><div class="label">Insurance</div><div class="value" id="ladderIns">1</div></div>
          </div>

          <div class="offers" id="ladderOffers"></div>

          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
            <button id="ladderUseReroll">Use Reroll</button>
            <button id="ladderUseIns">Buy Insurance (cost 25%)</button>
          </div>

          <p class="muted" style="margin-top:10px;">
            Score only increases from <b>wins</b> and <b>cash-outs</b>. Losing ends the run unless insured.
          </p>
        </div>
      </div>

      <!-- ROULETTE DRAFT -->
      <div id="screenDraft" style="display:none;">
        <div class="topline">
          <div class="pill"><b>Roulette Draft</b> — build slip, then spin</div>
          <div class="tabs">
            <span class="chip tab active">Play</span>
            <button class="tab" id="draftNew">New Run</button>
            <button class="tab" id="draftSpin">SPIN</button>
          </div>
        </div>

        <div class="card">
          <div class="stats">
            <div class="stat"><div class="label">Slip Size</div><div class="value" id="draftSize">0</div></div>
            <div class="stat"><div class="label">Success Chance</div><div class="value" id="draftP">100%</div></div>
            <div class="stat"><div class="label">Payout Mult</div><div class="value" id="draftMult">1.00×</div></div>
            <div class="stat"><div class="label">Potential</div><div class="value" id="draftPot">0</div></div>
          </div>

          <div class="twoCol">
            <div>
              <p class="muted" style="margin:0 0 6px;">Draft one tile:</p>
              <div class="offers" id="draftOffers" style="grid-template-columns: 1fr;"></div>
            </div>
            <div>
              <p class="muted" style="margin:0 0 6px;">Your slip:</p>
              <div class="list" id="draftSlip"></div>
            </div>
          </div>

          <p class="muted" style="margin-top:10px;">
            Your overall success chance is the product of tile chances. Spin resolves all at once.
          </p>
        </div>
      </div>

      <!-- LOOTBOX -->
      <div id="screenLoot" style="display:none;">
        <div class="topline">
          <div class="pill"><b>Lootbox Math</b> — transparent odds, limited manipulation</div>
          <div class="tabs">
            <span class="chip tab active">Play</span>
            <button class="tab" id="lootNew">New Run</button>
            <button class="tab" id="lootOpen">OPEN PACK</button>
          </div>
        </div>

        <div class="card">
          <div class="stats">
            <div class="stat"><div class="label">Score</div><div class="value" id="lootScore">0</div></div>
            <div class="stat"><div class="label">Packs Opened</div><div class="value" id="lootPacks">0</div></div>
            <div class="stat"><div class="label">Boosts Left</div><div class="value" id="lootBoosts">3</div></div>
            <div class="stat"><div class="label">Locks Left</div><div class="value" id="lootLocks">1</div></div>
          </div>

          <div style="margin-top:12px;">
            <p class="muted" style="margin:0 0 8px;">Odds (sum = 100%):</p>
            <div class="bar" title="Common / Rare / Epic / Bust">
              <div id="lootBar" style="width:100%; display:flex;">
                <div id="segCommon"></div>
                <div id="segRare"></div>
                <div id="segEpic"></div>
                <div id="segBust"></div>
              </div>
            </div>
            <div class="twoCol" style="margin-top:10px;">
              <div class="muted" id="lootOddsText"></div>
              <div class="muted" id="lootNote"></div>
            </div>
          </div>

          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
            <button id="lootBoost">Boost Rare (+6%)</button>
            <button id="lootStabilize">Stabilize (reduce Bust -4%)</button>
            <button id="lootLock">Lock Odds (next open)</button>
          </div>

          <p class="muted" style="margin-top:10px;">
            This is a probability toy, but not a mindless one: boosts trade off against bust risk and diminishing returns.
          </p>
        </div>
      </div>
    </section>

    <aside class="sidebar">
      <div class="card">
        <h2>Run Log</h2>
        <p class="muted">Shows what happened. If a game feels “random nonsense,” the log will tell you why.</p>
        <div class="list" id="log"></div>
      </div>

      <div class="card">
        <h2>Best Scores</h2>
        <div class="stats">
          <div class="stat"><div class="label">Odds Ladder</div><div class="value" id="bestLadder">0</div></div>
          <div class="stat"><div class="label">Roulette Draft</div><div class="value" id="bestDraft">0</div></div>
          <div class="stat"><div class="label">Lootbox Math</div><div class="value" id="bestLoot">0</div></div>
          <div class="stat"><div class="label">All-Time Best</div><div class="value" id="bestAll2">0</div></div>
        </div>
      </div>

      <div class="card">
        <h2>Next upgrades</h2>
        <p class="muted">
          - Daily seed mode (same offers for everyone)<br>
          - Streak multipliers + “tilt” systems<br>
          - Clean sound + haptics (mobile)<br>
          - Leaderboard (even just local first)
        </p>
      </div>
    </aside>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ===================== Shared helpers =====================
    const $ = (sel) => document.querySelector(sel);
    const toast = $("#toast");
    const logEl = $("#log");

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>toast.classList.remove("show"), 900);
    }

    function log(msg){
      const div = document.createElement("div");
      div.className = "log";
      div.innerHTML = msg;
      logEl.prepend(div);
      // Keep it tidy
      while(logEl.children.length > 24) logEl.removeChild(logEl.lastChild);
    }

    function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }
    function rint(a,b){ return Math.floor(a + Math.random()*(b-a+1)); } // inclusive
    function choice(arr){ return arr[(Math.random()*arr.length)|0]; }
    function pct(x){ return Math.round(x*100); }

    // localStorage bests
    const STORE_KEY = "microcasino_bests_v1";
    const bests = JSON.parse(localStorage.getItem(STORE_KEY) || "{}");
    function getBest(k){ return bests[k] || 0; }
    function setBest(k, v){
      bests[k] = Math.max(getBest(k), v);
      localStorage.setItem(STORE_KEY, JSON.stringify(bests));
      renderBests();
    }
    function renderBests(){
      const bL = getBest("ladder");
      const bD = getBest("draft");
      const bO = getBest("loot");
      const all = Math.max(bL,bD,bO);
      $("#bestLadder").textContent = bL;
      $("#bestDraft").textContent = bD;
      $("#bestLoot").textContent = bO;
      $("#bestAll").textContent = all;
      $("#bestAll2").textContent = all;
    }
    renderBests();

    // ===================== Router =====================
    const screens = {
      home: $("#screenHome"),
      ladder: $("#screenLadder"),
      draft: $("#screenDraft"),
      loot: $("#screenLoot"),
    };
    function showScreen(name){
      for(const k in screens) screens[k].style.display = (k === name) ? "block" : "none";
      if(name === "home") showToast("Pick a game");
    }
    showScreen("home");

    document.addEventListener("click", (e)=>{
      const btn = e.target.closest("[data-open]");
      if(btn){
        showScreen(btn.dataset.open);
        log(`Opened <b>${btn.dataset.open}</b>.`);
      }
    });
    $("#btnHome").addEventListener("click", ()=>showScreen("home"));
    $("#btnResetAll").addEventListener("click", ()=>{
      localStorage.removeItem(STORE_KEY);
      for(const k in bests) delete bests[k];
      renderBests();
      log(`Reset <b>all</b> saved bests.`);
      showToast("Reset");
    });

    // ===================== Game 1: Odds Ladder =====================
    const ladder = {
      bank: 100,
      round: 1,
      rerolls: 2,
      insurance: 1,
      insured: false,
      alive: true,
      offers: []
    };

    const ladderUI = {
      bank: $("#ladderBank"),
      round: $("#ladderRound"),
      reroll: $("#ladderReroll"),
      ins: $("#ladderIns"),
      offers: $("#ladderOffers"),
      btnNew: $("#ladderNew"),
      btnCash: $("#ladderCash"),
      btnReroll: $("#ladderUseReroll"),
      btnBuyIns: $("#ladderUseIns"),
    };

    function ladderReset(){
      ladder.bank = 100;
      ladder.round = 1;
      ladder.rerolls = 2;
      ladder.insurance = 1;
      ladder.insured = false;
      ladder.alive = true;
      ladderNewOffers();
      ladderRender();
      log(`Odds Ladder: new run. Bank <b>${ladder.bank}</b>.`);
      showToast("New run");
    }

    // Generate 3 offers: one "safe", one "value", one "greed"
    function ladderNewOffers(){
      const r = ladder.round;

      // Difficulty curve: higher rounds => lower p, higher reward
      // Keep the offers readable and not purely random.
      const safe = {
        name: "Safe",
        p: clamp(0.82 - r*0.02, 0.55, 0.85),
        gain: Math.round(ladder.bank * clamp(0.18 - r*0.005, 0.08, 0.18))
      };
      const value = {
        name: "Value",
        p: clamp(0.62 - r*0.02, 0.28, 0.62),
        gain: Math.round(ladder.bank * clamp(0.55 + r*0.02, 0.55, 1.20))
      };
      const greed = {
        name: "Greed",
        p: clamp(0.38 - r*0.02, 0.10, 0.38),
        gain: Math.round(ladder.bank * clamp(1.40 + r*0.07, 1.40, 3.80))
      };

      // Nudge: sometimes make "value" actually best EV, sometimes a trap.
      // EV = p*gain - (1-p)*lossCost (here loss ends run, so psychological cost).
      // We'll keep it simple: random slight adjustment within tight bounds.
      function tweak(o){
        const dp = (Math.random()-0.5) * 0.06; // +/-3%
        const dg = (Math.random()-0.5) * 0.10; // +/-5%
        o.p = clamp(o.p + dp, 0.08, 0.92);
        o.gain = Math.max(10, Math.round(o.gain * (1 + dg)));
        return o;
      }

      ladder.offers = [tweak(safe), tweak(value), tweak(greed)];
    }

    function ladderRender(){
      ladderUI.bank.textContent = ladder.bank;
      ladderUI.round.textContent = ladder.round;
      ladderUI.reroll.textContent = ladder.rerolls;
      ladderUI.ins.textContent = ladder.insurance + (ladder.insured ? " (armed)" : "");
      ladderUI.btnCash.disabled = !ladder.alive;
      ladderUI.btnReroll.disabled = ladder.rerolls <= 0 || !ladder.alive;
      ladderUI.btnBuyIns.disabled = ladder.insurance <= 0 || ladder.insured || !ladder.alive;

      ladderUI.offers.innerHTML = "";
      ladder.offers.forEach((o, idx)=>{
        const ev = o.p * o.gain; // simple EV proxy for “feel”
        const div = document.createElement("div");
        div.className = "offer";
        div.innerHTML = `
          <div class="name">${o.name}</div>
          <div class="meta">Win chance: <b>${Math.round(o.p*100)}%</b><br>Win gain: <b>+${o.gain}</b><br><span class="muted">EV-ish: ${Math.round(ev)}</span></div>
          <div class="big">Pick</div>
        `;
        div.addEventListener("click", ()=>ladderPick(idx));
        ladderUI.offers.appendChild(div);
      });
    }

    function ladderPick(i){
      if(!ladder.alive) return;
      const o = ladder.offers[i];
      const roll = Math.random();
      const win = roll < o.p;

      if(win){
        ladder.bank += o.gain;
        ladder.round += 1;
        ladder.insured = false; // insurance is “used” only on loss
        ladderNewOffers();
        ladderRender();
        log(`Ladder: picked <b>${o.name}</b> (${Math.round(o.p*100)}%). Rolled <b>${roll.toFixed(2)}</b> → <b class="good">WIN</b> +${o.gain}. Bank <b>${ladder.bank}</b>.`);
        showToast("WIN");
      } else {
        if(ladder.insured){
          // insurance triggers: lose 40% bank, survive
          const loss = Math.floor(ladder.bank * 0.40);
          ladder.bank = Math.max(0, ladder.bank - loss);
          ladder.insured = false;
          ladderNewOffers();
          ladderRender();
          log(`Ladder: picked <b>${o.name}</b>. Rolled <b>${roll.toFixed(2)}</b> → <b class="warn">INSURANCE SAVED YOU</b>. -${loss}. Bank <b>${ladder.bank}</b>.`);
          showToast("Saved!");
        } else {
          ladder.alive = false;
          ladderRender();
          setBest("ladder", ladder.bank);
          log(`Ladder: picked <b>${o.name}</b>. Rolled <b>${roll.toFixed(2)}</b> → <b class="bad">LOSE</b>. Run ended. Final <b>${ladder.bank}</b>.`);
          showToast("BUST");
        }
      }
    }

    ladderUI.btnNew.addEventListener("click", ladderReset);
    ladderUI.btnCash.addEventListener("click", ()=>{
      if(!ladder.alive) return;
      ladder.alive = false;
      setBest("ladder", ladder.bank);
      ladderRender();
      log(`Ladder: <b class="good">CASH OUT</b> at <b>${ladder.bank}</b>.`);
      showToast("Cashed out");
    });
    ladderUI.btnReroll.addEventListener("click", ()=>{
      if(ladder.rerolls <= 0 || !ladder.alive) return;
      ladder.rerolls -= 1;
      ladderNewOffers();
      ladderRender();
      log(`Ladder: used <b>Reroll</b>.`);
      showToast("Rerolled");
    });
    ladderUI.btnBuyIns.addEventListener("click", ()=>{
      if(ladder.insurance <= 0 || ladder.insured || !ladder.alive) return;
      ladder.insurance -= 1;
      // cost 25% bank (forces decision)
      const cost = Math.floor(ladder.bank * 0.25);
      ladder.bank = Math.max(0, ladder.bank - cost);
      ladder.insured = true;
      ladderRender();
      log(`Ladder: bought <b>Insurance</b>. Cost -${cost}. Bank <b>${ladder.bank}</b>.`);
      showToast("Insured");
    });

    ladderReset();

    // ===================== Game 2: Roulette Draft =====================
    const draft = {
      slip: [],
      offers: [],
      baseStake: 100
    };

    function draftReset(){
      draft.slip = [];
      draft.baseStake = 100;
      draftNewOffers();
      draftRender();
      log(`Draft: new run. Stake <b>${draft.baseStake}</b>.`);
      showToast("New run");
    }

    function draftNewOffers(){
      // Offer 3 tiles; choose 1 each time.
      // Each tile is (p, mult) where expected return varies.
      // We include one “safe”, one “mid”, one “wild”.
      const tiles = [];

      function makeTile(type){
        let p, m;
        if(type === "safe"){
          p = (rint(65, 85))/100;
          m = 1 + (rint(15, 45))/100; // 1.15-1.45
        } else if(type === "mid"){
          p = (rint(35, 60))/100;
          m = 1 + (rint(60, 140))/100; // 1.60-2.40
        } else {
          p = (rint(10, 30))/100;
          m = 1 + (rint(220, 700))/100; // 3.20-8.00
        }

        // tiny perturbations
        p = clamp(p + (Math.random()-0.5)*0.04, 0.05, 0.95);
        m = clamp(m + (Math.random()-0.5)*0.20, 1.05, 9.00);

        return { p, m, label: `${Math.round(p*100)}% → ${m.toFixed(2)}×` };
      }

      tiles.push(makeTile("safe"), makeTile("mid"), makeTile("wild"));
      draft.offers = tiles;
    }

    function draftStats(){
      // Overall P = product of p's
      // Overall mult = product of m's
      let P = 1;
      let M = 1;
      for(const t of draft.slip){ P *= t.p; M *= t.m; }
      return {P, M};
    }

    function draftRender(){
      $("#draftSize").textContent = draft.slip.length;
      const {P, M} = draftStats();
      $("#draftP").textContent = `${Math.round(P*100)}%`;
      $("#draftMult").textContent = `${M.toFixed(2)}×`;
      $("#draftPot").textContent = Math.floor(draft.baseStake * M);

      const offers = $("#draftOffers");
      offers.innerHTML = "";
      draft.offers.forEach((t, i)=>{
        const div = document.createElement("div");
        div.className = "offer";
        const ev = t.p * t.m; // EV-ish per tile
        div.innerHTML = `
          <div class="name">Draft Tile</div>
          <div class="meta">${t.label}<br><span class="muted">EV-ish: ${ev.toFixed(2)}×</span></div>
          <div class="big">Add</div>
        `;
        div.addEventListener("click", ()=>{
          draft.slip.push(t);
          draftNewOffers();
          draftRender();
          log(`Draft: added tile <b>${Math.round(t.p*100)}%</b> → <b>${t.m.toFixed(2)}×</b>. Slip size <b>${draft.slip.length}</b>.`);
          showToast("Drafted");
        });
        offers.appendChild(div);
      });

      const slipEl = $("#draftSlip");
      slipEl.innerHTML = "";
      if(draft.slip.length === 0){
        const d = document.createElement("div");
        d.className = "log";
        d.innerHTML = `No tiles yet. Draft 3–6 then spin.`;
        slipEl.appendChild(d);
      } else {
        draft.slip.forEach((t, idx)=>{
          const d = document.createElement("div");
          d.className = "log";
          d.innerHTML = `#${idx+1}: <b>${Math.round(t.p*100)}%</b> → <b>${t.m.toFixed(2)}×</b>`;
          slipEl.appendChild(d);
        });
      }
    }

    $("#draftNew").addEventListener("click", draftReset);
    $("#draftSpin").addEventListener("click", ()=>{
      const {P, M} = draftStats();
      if(draft.slip.length === 0){
        showToast("Draft first");
        return;
      }
      // Resolve: all must succeed
      let allWin = true;
      const rolls = [];
      for(const t of draft.slip){
        const roll = Math.random();
        rolls.push(roll);
        if(roll >= t.p) allWin = false;
      }

      if(allWin){
        const win = Math.floor(draft.baseStake * M);
        setBest("draft", win);
        log(`Draft: SPIN → <b class="good">HIT</b>. P=${Math.round(P*100)}%, Mult=${M.toFixed(2)}×. Payout <b>${win}</b>. Rolls: ${rolls.map(r=>r.toFixed(2)).join(", ")}`);
        showToast("HIT!");
      } else {
        log(`Draft: SPIN → <b class="bad">MISS</b>. P=${Math.round(P*100)}%, Mult=${M.toFixed(2)}×. Rolls: ${rolls.map(r=>r.toFixed(2)).join(", ")}`);
        showToast("Miss");
      }

      // New run automatically (fast loop)
      draftReset();
    });

    draftReset();

    // ===================== Game 3: Lootbox Math =====================
    const loot = {
      score: 0,
      packs: 0,
      boosts: 3,
      locks: 1,
      locked: false,
      odds: { common: 0.70, rare: 0.24, epic: 0.05, bust: 0.01 }
    };

    function lootNormalize(){
      // ensure odds sum to 1, clamp each
      const o = loot.odds;
      o.common = clamp(o.common, 0.00, 0.95);
      o.rare   = clamp(o.rare,   0.00, 0.80);
      o.epic   = clamp(o.epic,   0.00, 0.40);
      o.bust   = clamp(o.bust,   0.00, 0.40);
      const sum = o.common + o.rare + o.epic + o.bust;
      o.common /= sum; o.rare /= sum; o.epic /= sum; o.bust /= sum;
    }

    function lootReset(){
      loot.score = 0;
      loot.packs = 0;
      loot.boosts = 3;
      loot.locks = 1;
      loot.locked = false;
      loot.odds = { common: 0.70, rare: 0.24, epic: 0.05, bust: 0.01 };
      lootNormalize();
      lootRender();
      log(`Loot: new run. Odds reset.`);
      showToast("New run");
    }

    function lootRender(){
      $("#lootScore").textContent = loot.score;
      $("#lootPacks").textContent = loot.packs;
      $("#lootBoosts").textContent = loot.boosts + (loot.locked ? " (locked)" : "");
      $("#lootLocks").textContent = loot.locks;

      const o = loot.odds;
      $("#lootOddsText").innerHTML =
        `Common <b>${Math.round(o.common*100)}%</b> • Rare <b>${Math.round(o.rare*100)}%</b> • Epic <b>${Math.round(o.epic*100)}%</b> • Bust <b>${Math.round(o.bust*100)}%</b>`;

      $("#lootNote").innerHTML =
        loot.locked ? `<b class="good">Locked:</b> next open won’t drift.` : `Odds drift slightly after each open.`;

      // segments
      const segCommon = $("#segCommon");
      const segRare = $("#segRare");
      const segEpic = $("#segEpic");
      const segBust = $("#segBust");

      segCommon.style.width = `${o.common*100}%`;
      segRare.style.width = `${o.rare*100}%`;
      segEpic.style.width = `${o.epic*100}%`;
      segBust.style.width = `${o.bust*100}%`;

      segCommon.style.background = "rgba(122,167,255,.25)";
      segRare.style.background = "rgba(72,211,138,.25)";
      segEpic.style.background = "rgba(255,204,102,.35)";
      segBust.style.background = "rgba(255,107,107,.25)";

      $("#lootOpen").disabled = false;
      $("#lootBoost").disabled = loot.boosts <= 0;
      $("#lootStabilize").disabled = loot.boosts <= 0;
      $("#lootLock").disabled = loot.locks <= 0 || loot.locked;
    }

    function lootRoll(){
      const r = Math.random();
      const o = loot.odds;
      let acc = o.common;
      if(r < acc) return "common";
      acc += o.rare;
      if(r < acc) return "rare";
      acc += o.epic;
      if(r < acc) return "epic";
      return "bust";
    }

    function lootDrift(){
      // small deterministic-ish drift: chase increases bust slightly unless locked
      if(loot.locked){ loot.locked = false; return; }

      // drift: if epic is high, bust creeps up; otherwise rare creeps up slightly
      const o = loot.odds;
      // subtle randomness but bounded
      const delta = (Math.random()*0.010) + 0.004; // 0.4%..1.4%
      o.bust = clamp(o.bust + delta*0.5, 0.005, 0.20);
      o.rare = clamp(o.rare + delta*0.3, 0.05, 0.70);
      o.common = clamp(o.common - delta*0.6, 0.05, 0.90);
      // epic stays mostly stable unless boosted by actions
      lootNormalize();
    }

    $("#lootNew").addEventListener("click", lootReset);
    $("#lootOpen").addEventListener("click", ()=>{
      const result = lootRoll();
      loot.packs++;

      let gain = 0;
      if(result === "common") gain = 30;
      if(result === "rare") gain = 120;
      if(result === "epic") gain = 600;
      if(result === "bust") gain = -80;

      loot.score = Math.max(0, loot.score + gain);
      setBest("loot", loot.score);

      const cls = (result === "epic") ? "good" : (result === "bust" ? "bad" : "warn");
      log(`Loot: OPEN → <b class="${cls}">${result.toUpperCase()}</b> (${gain>=0?"+":""}${gain}). Score <b>${loot.score}</b>.`);
      showToast(result === "epic" ? "EPIC!" : (result === "bust" ? "BUST" : "Hit"));

      lootDrift();
      lootRender();
    });

    $("#lootBoost").addEventListener("click", ()=>{
      if(loot.boosts <= 0) return;
      loot.boosts--;
      // boost rare +6%, cost: increase bust +2%, reduce common
      loot.odds.rare += 0.06;
      loot.odds.bust += 0.02;
      loot.odds.common -= 0.08;
      lootNormalize();
      lootRender();
      log(`Loot: used <b>Boost Rare</b>.`);
      showToast("Boosted");
    });

    $("#lootStabilize").addEventListener("click", ()=>{
      if(loot.boosts <= 0) return;
      loot.boosts--;
      // reduce bust -4%, split into common/rare (safer)
      loot.odds.bust -= 0.04;
      loot.odds.common += 0.02;
      loot.odds.rare += 0.02;
      lootNormalize();
      lootRender();
      log(`Loot: used <b>Stabilize</b>.`);
      showToast("Stabilized");
    });

    $("#lootLock").addEventListener("click", ()=>{
      if(loot.locks <= 0 || loot.locked) return;
      loot.locks--;
      loot.locked = true;
      lootRender();
      log(`Loot: used <b>Lock Odds</b> (next open).`);
      showToast("Locked");
    });

    lootReset();

    // Keep best display in sync
    function syncBestsOnLoad(){
      renderBests();
    }
    syncBestsOnLoad();
  </script>
</body>
</html>
